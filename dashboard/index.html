<!-- V2 -->
<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>배차 대시보드</title>
    <!-- Google Charts 라이브러리 로드 -->
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- 부트스트랩 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body {
        font-family: 'Noto Sans KR', Arial, sans-serif;
        background-color: #f8f9fa;
        padding: 20px;
      }
      .dashboard-title {
        color: #343a40;
        margin-bottom: 30px;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 10px;
      }
      .card {
        margin-bottom: 20px;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: none;
        border-radius: 10px;
        overflow: hidden;
      }
      .card-header {
        background-color: #f1f3f5;
        font-weight: bold;
        color: #495057;
        border-bottom: 1px solid rgba(0,0,0,.125);
        padding: 0.75rem 1.25rem;
      }
      /* 차트 컨테이너 강제 크기 지정 */
      .chart-container {
        width: 100% !important;
        height: 300px !important;
        min-height: 300px;
        position: relative;
        overflow: visible !important;
      }
      
      /* 차트 내부 요소 강제 크기 조정 */
      .chart-container > div {
        width: 100% !important;
        height: 100% !important;
      }
      .chart-container svg {
        width: 100% !important;
        height: 100% !important;
        overflow: visible;
      }
      /* Google 차트 관련 요소 */
      .google-visualization-table-table {
        width: 100%;
      }
      .summary-value {
        font-size: 24px;
        font-weight: bold;
        color: #1e88e5;
      }
      .summary-label {
        color: #757575;
        font-size: 14px;
      }
      .loading {
        text-align: center;
        padding: 50px;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }
      .table-responsive {
        overflow-x: auto;
      }
      .table th {
        background-color: #f1f3f5;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .sortable {
        cursor: pointer;
      }
      .sortable:hover {
        background-color: #e9ecef;
      }
      .mini-loader {
        display: inline-block;
        margin-left: 10px;
      }
      /* 메달 아이콘 스타일 */
      .medal-gold {
        color: gold;
        font-size: 1.2em;
        margin-right: 5px;
      }
      .medal-silver {
        color: silver;
        font-size: 1.2em;
        margin-right: 5px;
      }
      .medal-bronze {
        color: #CD7F32;
        font-size: 1.2em;
        margin-right: 5px;
      }
      /* 검색 필터 스타일 */
      #dispatcher-filter {
        width: 200px;
      }
      #clear-filter {
        cursor: pointer;
      }
      /* 새로고침 버튼 스타일 */
      #refreshButton {
        padding: 5px 15px;
        border-radius: 20px;
        transition: all 0.3s ease;
      }
      #refreshButton:hover {
        background-color: #0d6efd;
        color: white;
      }
      #refreshButton i {
        margin-right: 5px;
      }
      /* 테이블 정렬 아이콘 스타일 */
      .sortable i {
        margin-left: 5px;
        font-size: 0.85em;
        color: #adb5bd;
      }
      .fa-sort-up, .fa-sort-down {
        color: #0d6efd !important;
      }
      /* 모바일 최적화 */
      @media (max-width: 768px) {
        .card-body {
          padding: 0.75rem;
        }
        .chart-container {
          height: 250px;
        }
      }
      
      /* 담당자별 상세 통계 테이블 스타일 */
      #dispatcher-stats-table {
        border-collapse: collapse;
        width: 100%;
        table-layout: auto; /* 내용물에 맞게 자동 조정 */
      }
      
      #dispatcher-stats-table th {
        border: 1px solid #dee2e6; /* 헤더 셀에 실선 테두리 */
        padding: 8px;
        white-space: nowrap; /* 텍스트 줄바꿈 방지 */
      }
      
      #dispatcher-stats-table td {
        border-top: 1px solid #dee2e6; /* 상단 테두리는 실선 */
        border-bottom: 1px solid #dee2e6; /* 하단 테두리는 실선 */
        border-left: 1px dashed #dee2e6; /* 좌측 테두리는 점선 */
        border-right: 1px dashed #dee2e6; /* 우측 테두리는 점선 */
        padding: 8px;
        white-space: nowrap; /* 텍스트 줄바꿈 방지 */
        position: relative; /* 배경 막대를 위한 상대 위치 설정 */
      }
      
      /* 목표 달성 스타일 */
      .goal-achieved {
        background-color: #d4edda;
        color: #155724;
        font-weight: bold;
        border-radius: 4px;
        padding: 2px 6px;
      }
      
      .goal-not-achieved {
        background-color: #f8d7da;
        color: #721c24;
        font-weight: bold;
        border-radius: 4px;
        padding: 2px 6px;
      }
      
      /* 총 건수 배경 막대 스타일 */
      .total-bar {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        background-color: rgba(0, 123, 255, 0.1);
        z-index: -1;
      }
      
      /* 점수 스타일 */
      .score-high {
        color: #28a745;
        font-weight: bold;
      }
      
      .score-medium {
        color: #fd7e14;
        font-weight: bold;
      }
      
      .score-low {
        color: #dc3545;
        font-weight: bold;
      }
      
      /* 시프트 스타일 */
      .shift-op {
        background-color: #0d6efd; /* 파랑색 배경 */
        color: white; /* 흰색 글자 */
        padding: 2px 5px;
        border-radius: 3px;
      }
      
      .shift-mid {
        background-color: #198754; /* 초록색 배경 */
        color: white; /* 흰색 글자 */
        padding: 2px 5px;
        border-radius: 3px;
      }
      
      .shift-cl {
        background-color: #8B0000; /* 검붉은 배경 */
        color: white; /* 흰색 글자 */
        padding: 2px 5px;
        border-radius: 3px;
      }
      
      .shift-nt {
        background-color: #343a40; /* 짙은 회색 배경 */
        color: white; /* 흰색 글자 */
        padding: 2px 5px;
        border-radius: 3px;
      }
      
      .shift-mc {
        background: linear-gradient(to right, #CD853F, #8B4513); /* 밝은 갈색 그라데이션 */
        color: white; /* 흰색 글자 */
        padding: 2px 5px;
        border-radius: 3px;
      }
      
      .shift-4 {
        color: yellow; /* 노란색 글자 */
      }
      
      /* 스파크라인 컨테이너 */
      .sparkline-container {
        display: inline-block;
        margin-left: 5px;
        vertical-align: middle;
      }
      
      /* 처리 불가 비율 스타일 */
      .cant-process-high {
        background-color: rgba(220, 53, 69, 0.2);
      }
      
      .cant-process-medium {
        background-color: rgba(255, 193, 7, 0.2);
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <h1 class="dashboard-title">배차 실적 대시보드</h1>
      
      <!-- 로딩 표시 -->
      <div id="loading" class="loading" style="opacity: 0; transition: opacity 0.5s ease-in-out;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">로딩 중...</span>
        </div>
        <p class="mt-2">데이터를 불러오는 중입니다...</p>
      </div>
      
      <div class="mb-3">
        <button id="refreshButton" class="btn btn-outline-primary">
          <i class="fas fa-sync-alt"></i> 데이터 새로고침
        </button>
        <span class="ms-2 mini-loader" style="display: none;">
          <div class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="visually-hidden">로딩 중...</span>
          </div>
        </span>
      </div>
      
      <div id="dashboard-content" style="display: none; transition: opacity 0.5s ease-in-out;">
        <div class="row">
          <!-- 요약 통계 카드 -->
          <div class="col-md-3 mb-4">
            <div class="card h-100">
              <div class="card-header">총 배차 건수</div>
              <div class="card-body d-flex align-items-center justify-content-center">
                <div class="text-center">
                  <div id="total-count" class="summary-value">-</div>
                  <div class="summary-label">Total Dispatches</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-3 mb-4">
            <div class="card h-100">
              <div class="card-header">시스템 배차 비율</div>
              <div class="card-body d-flex align-items-center justify-content-center">
                <div class="text-center">
                  <div id="system-dispatch-rate" class="summary-value">-</div>
                  <div class="summary-label">System Dispatch Rate</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-3 mb-4">
            <div class="card h-100">
              <div class="card-header">오퍼레이터 배차 비율</div>
              <div class="card-body d-flex align-items-center justify-content-center">
                <div class="text-center">
                  <div id="operator-dispatch-rate" class="summary-value">-</div>
                  <div class="summary-label">Operator Dispatch Rate</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-3 mb-4">
            <div class="card h-100">
              <div class="card-header">평균 지연 시간</div>
              <div class="card-body d-flex align-items-center justify-content-center">
                <div class="text-center">
                  <div id="avg-delay-time" class="summary-value">-</div>
                  <div class="summary-label">Average Delay Time (seconds)</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <!-- 배차 결과 분포 차트 -->
          <div class="col-md-6 mb-4">
            <div class="card h-100">
              <div class="card-header">배차 결과 분포</div>
              <div class="card-body">
                <div id="dispatch-result-chart" class="chart-container"></div>
              </div>
            </div>
          </div>
          
          <!-- 담당자별 실적 분포 차트 -->
          <div class="col-md-6 mb-4">
            <div class="card h-100">
              <div class="card-header">담당자별 실적 분포</div>
              <div class="card-body">
                <div id="dispatcher-chart" class="chart-container"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <!-- 시간대별 배차 건수 차트 -->
          <div class="col-md-6 mb-4">
            <div class="card h-100">
              <div class="card-header">시간대별 배차 건수</div>
              <div class="card-body">
                <div id="hourly-chart" class="chart-container"></div>
              </div>
            </div>
          </div>
          
          <!-- 지역별 배차 건수 차트 -->
          <div class="col-md-6 mb-4">
            <div class="card h-100">
              <div class="card-header">지역별 배차 건수</div>
              <div class="card-body">
                <div id="region-chart" class="chart-container"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <!-- 고성과자/저성과자 카드 -->
          <div class="col-md-6 mb-4">
            <div class="card">
              <div class="card-header">고성과자 Top 5</div>
              <div class="card-body table-responsive p-0" style="max-height: 300px;">
                <table class="table table-striped table-hover mb-0">
                  <thead>
                    <tr>
                      <th>순위</th>
                      <th>담당자</th>
                      <th>총 건수</th>
                      <th data-tooltip="performance-formula" cursor="pointer" title="성과 점수 계산 공식: 총 점수(20%) + 오퍼레이터 배차 비중(50%) + 평균 소요시간 역수(30%)">총 점수(i)</th>
                      <th>오퍼레이터 배차</th>
                      <th>평균 소요시간</th>
                    </tr>
                  </thead>
                  <tbody id="top-performers-body">
                    <!-- 여기에 자바스크립트로 행이 추가됩니다 -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <div class="col-md-6 mb-4">
            <div class="card">
              <div class="card-header">저성과자 Bottom 5</div>
              <div class="card-body table-responsive p-0" style="max-height: 300px;">
                <table class="table table-striped table-hover mb-0">
                  <thead>
                    <tr>
                      <th>순위</th>
                      <th>담당자</th>
                      <th>총 건수</th>
                      <th data-tooltip="performance-formula" cursor="pointer" title="성과 점수 계산 공식: 총 점수(20%) + 오퍼레이터 배차 비중(50%) + 평균 소요시간 역수(30%)">총 점수(i)</th>
                      <th>오퍼레이터 배차</th>
                      <th>평균 소요시간</th>
                    </tr>
                  </thead>
                  <tbody id="bottom-performers-body">
                    <!-- 여기에 자바스크립트로 행이 추가됩니다 -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 담당자별 상세 통계 테이블 -->
        <div class="row">
          <div class="col-12 mb-4">
            <div class="card">
              <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">담당자별 상세 통계</h6>
                <div>
                  <div class="input-group">
                    <input type="text" id="dispatcher-filter" class="form-control" placeholder="담당자 검색...">
                    <div class="input-group-append">
                      <button id="clear-filter" class="btn btn-outline-secondary" type="button">
                        <i class="fas fa-times"></i>
                      </button>
                      <button id="capture-table" class="btn btn-outline-primary" type="button" title="테이블 캡처">
                        <i class="fas fa-camera"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table id="dispatcher-stats-table" class="table table-striped table-hover text-center">
                    <thead class="text-center">
                      <tr>
                        <th class="sortable" data-sort="dispatcher">
                          담당자 <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" data-sort="workShift">
                          시프트 <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" data-sort="workHours">
                          WH <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" data-sort="total">
                          총 건수 <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" cursor="pointer" data-sort="score">
                          총 점수(i) <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" data-sort="operator">
                          오퍼레이터 배차 <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" data-sort="system">
                          시스템 배차 <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" data-sort="cantProcess">
                          처리 불가 <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" data-sort="avgTime">
                          평균 소요시간 <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" data-sort="goalAchievement">
                          목표 달성 <i class="fas fa-sort"></i>
                        </th>
                        <!-- <th class="sortable" data-sort="normal">
                          정상 이동 중 <i class="fas fa-sort"></i>
                        </th> -->
                        <!-- <th class="sortable" data-sort="other">
                          기타 <i class="fas fa-sort"></i>
                        </th> -->
                      </tr>
                    </thead>
                    <tbody id="dispatcher-stats-body" class="text-center">
                      <!-- 여기에 자바스크립트로 행이 추가됩니다 -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- jQuery 추가 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- 부트스트랩 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- sparkline 라이브러리 추가 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-sparklines/2.1.2/jquery.sparkline.min.js"></script>
    
    <!-- html2canvas 라이브러리 추가 -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
  <!-- 차트 및 데이터 처리 스크립트 -->
  <script>
    // Google Charts 라이브러리 로드
    google.charts.load('current', {'packages':['corechart', 'bar', 'table']});
    google.charts.setOnLoadCallback(initCharts);
    
    // 전역 변수
    let dispatcherStatsData = {};
    let workPerformanceData = null;
    let currentSort = { column: 'total', direction: 'desc', clickCount: 0 };
    let filterText = '';
    let isLoading = false;
    let chartData = {
      hourly: [],
      regions: [],
      summary: null
    };
    
    // 로딩 표시 함수
    function showLoading() {
      const loadingElement = document.getElementById('loading');
      if (loadingElement) {
        loadingElement.style.opacity = '1';
        loadingElement.style.display = 'flex';
      }
      
      const dashboardContent = document.getElementById('dashboard-content');
      if (dashboardContent) {
        dashboardContent.style.opacity = '0';
        dashboardContent.style.display = 'none';
      }
    }
    
    // 로딩 숨김 함수
    function hideLoading() {
      const loadingElement = document.getElementById('loading');
      if (loadingElement) {
        loadingElement.style.opacity = '0';
        setTimeout(() => {
          loadingElement.style.display = 'none';
        }, 500);
      }
      
      const dashboardContent = document.getElementById('dashboard-content');
      if (dashboardContent) {
        dashboardContent.style.display = 'block';
        setTimeout(() => {
          dashboardContent.style.opacity = '1';
        }, 50);
      }
      
      // 차트 크기 조정 및 다시 그리기
      if (typeof fixChartDisplay === 'function') {
        fixChartDisplay();
      }
      
      // 자동 새로고침 설정
      if (typeof setupAutoRefresh === 'function') {
        setupAutoRefresh();
      }
    }
    
    // 차트 초기화
    function initCharts() {
      // 데이터 로드 시작
      loadData();
    }
    
    // 데이터 새로고침 타이머
    let refreshTimer = null;
    
    // 서버에서 데이터 로드
    async function loadData(showSpinner = true, forceWorkPerformanceRefresh = false) {
      if (isLoading) return; // 이미 로드 중이면 중복 요청 방지
      isLoading = true;
      
      // 로딩 표시
      if (showSpinner) {
        showLoading();
      }
      
      try {
        // 근무자 실적 데이터 로드
        // 비동기 처리를 위한 Promise 생성
        const loadWorkPerformanceData = new Promise((resolve) => {
          google.script.run
            .withSuccessHandler((data) => {
              workPerformanceData = data || {};  // null이면 빈 객체로 초기화
              console.log('근무자 실적 데이터 로드 완료');
              resolve();
            })
            .withFailureHandler((error) => {
              console.error('근무자 실적 데이터 로드 오류:', error);
              workPerformanceData = {};  // 오류 발생 시 빈 객체로 초기화
              resolve();
            })
            .getWorkPerformanceData();
        });
        
        // 근무자 실적 데이터 로드 완료 대기
        await loadWorkPerformanceData;
        console.log('근무자 실적 데이터 로드 완료:', workPerformanceData);
        
        // 데이터 가져오기
        const data = await fetchData();
        
        if (!data) {
          showError('데이터를 가져오는데 실패했습니다.');
          isLoading = false;
          return;
        }
        
        // 데이터 처리
        processData(data);
        
        // 로딩 숨기기
        if (showSpinner) {
          hideLoading();
        }
        
        isLoading = false;
      } catch (error) {
        console.error('데이터 로드 중 오류:', error);
        showError('데이터 로드 중 오류가 발생했습니다.');
        isLoading = false;
      }
    }
    
    // 담당자별 통계를 저장할 전역 변수
    
    // 담당자별 통계 표시
    function displayDispatcherStats(stats) {
      // 전역 변수에 데이터 저장
      dispatcherStatsData = stats;
      
      // 담당자 차트 데이터 생성
      const chartContainer = document.getElementById('dispatcher-chart');
      
      try {
        // DataTable 생성
        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', '담당자');
        dataTable.addColumn('number', '점수');
        dataTable.addColumn({type: 'string', role: 'tooltip', p: {html: true}});
        
        // 행 추가
        Object.keys(stats).forEach(dispatcher => {
          const score = stats[dispatcher].totalScore;
          const total = stats[dispatcher].total;
          const tooltip = `<div style="padding:10px;"><strong>${dispatcher}</strong><br>총 점수: ${score}<br>총 건수: ${total}</div>`;
          dataTable.addRow([dispatcher, score, tooltip]);
        });
        
        // 차트 옵션
        const options = {
          title: '담당자별 배차 점수',
          chartArea: {
            left: 50,
            top: 30,
            width: '80%',
            height: '75%'
          },
          legend: {position: 'none'},
          colors: ['#4285F4'],
          hAxis: {
            title: '담당자',
            slantedText: true,
            slantedTextAngle: 45
          },
          vAxis: {
            title: '점수',
            minValue: 0
          },
          width: '100%',
          height: '100%',
          tooltip: { isHtml: true }
        };
        
        // 차트 그리기
        const chart = new google.visualization.ColumnChart(chartContainer);
        chart.draw(dataTable, options);
        
        // 전역 함수 정의
        window.drawDispatcherChart = function() {
          try {
            chart.draw(dataTable, options);
          } catch(e) {
            console.error("Error drawing dispatcher chart:", e);
          }
        };
      
      } catch (e) {
        console.error("Error creating dispatcher chart:", e);
        chartContainer.innerHTML = '<div class="alert alert-warning">차트 로드 중 오류가 발생했습니다.</div>';
      }
      
      // 테이블 데이터 렌더링
      renderDispatcherTable();
      
      // 정렬 이벤트 리스너 설정
      setupSortListeners();
      
      // 필터 이벤트 리스너 설정
      setupFilterListeners();
    }
    
    // 데이터 필터링 및 정렬
    function filterAndSortData() {
      // 필터링
      let filteredData = [];
      
      for (const dispatcher in dispatcherStatsData) {
        if (filterText && !dispatcher.toLowerCase().includes(filterText.toLowerCase())) {
          continue;
        }
        
        filteredData.push({
          dispatcher,
          data: dispatcherStatsData[dispatcher]
        });
      }
      
      // 정렬
      filteredData.sort((a, b) => {
        let direction = currentSort.direction === 'asc' ? 1 : -1;
        
        // 정렬이 없는 경우 기본 순서 반환
        if (currentSort.direction === 'none') {
          return 0;
        }
        
        switch(currentSort.column) {
          case 'dispatcher':
            return direction * a.dispatcher.localeCompare(b.dispatcher);
          case 'total':
            return direction * (a.data.total - b.data.total);
          case 'score':
            return direction * (a.data.totalScore - b.data.totalScore);
          case 'system':
            return direction * (a.data.systemDispatch - b.data.systemDispatch);
          case 'operator':
            return direction * (a.data.operatorDispatch - b.data.operatorDispatch);
          case 'normal':
            return direction * (a.data.normalMoving - b.data.normalMoving);
          case 'cantProcess':
            return direction * (a.data.cantProcess - b.data.cantProcess);
          case 'other':
            return direction * (a.data.other - b.data.other);
          case 'avgTime':
            return direction * (a.data.avgTime - b.data.avgTime);
          case 'workShift':
            return direction * a.data.workShift.localeCompare(b.data.workShift);
          case 'workHours':
            return direction * (a.data.workHours - b.data.workHours);
          case 'goalAchievement':
            return direction * (a.data.goalAchievement - b.data.goalAchievement);
          default:
            return direction * (a.data.total - b.data.total);
        }
      });
      
      return filteredData;
    }
    
    // 담당자 통계 테이블 렌더링
    function renderDispatcherTable() {
      const tableBody = document.getElementById('dispatcher-stats-body');
      if (!tableBody) return;  // 테이블 본문이 없으면 함수 종료
      
      tableBody.innerHTML = '';
      
      // 데이터 필터링 및 정렬
      const filteredData = filterAndSortData();
      
      // 평균 총 건수 계산
      let totalCounts = filteredData.map(item => item.data.total);
      let avgTotalCount = totalCounts.length > 0 ? 
        totalCounts.reduce((sum, count) => sum + count, 0) / totalCounts.length : 0;
      
      // 최대 총 건수 (막대 그래프 최대값 설정용)
      let maxTotalCount = Math.max(...totalCounts, 1);
      
      // 행 추가
      filteredData.forEach(({dispatcher, data: s}) => {
        const row = tableBody.insertRow();
        
        // 담당자 셀
        const dispatcherCell = row.insertCell(0);
        dispatcherCell.textContent = dispatcher;
        
        // 근무자 실적 데이터 가져오기 (null 체크 추가)
        const performanceData = workPerformanceData && workPerformanceData[dispatcher.toString().toLowerCase().trim()];
        
        // 시프트 셀
        const shiftCell = row.insertCell(1);
        
        // 시프트 정보 표시 (workPerformanceData에서 가져오거나 기존 데이터 사용)
        if (performanceData && performanceData.workShift) {
          let shiftText = performanceData.workShift.toString();
          let shiftSpan = document.createElement('span');
          
          // M-4&C-4 시프트 처리 (최우선 적용)
          if (shiftText.includes('M-4&C') || shiftText.includes('M-4 & C') || shiftText.includes('M-4&C-4')) {
            shiftSpan.className = 'shift-mc';
            shiftSpan.textContent = shiftText; // 전체 텍스트를 그대로 표시
          } 
          // 다른 시프트 처리
          else {
            // 시프트 배경색 및 글자색 설정
            if (shiftText.includes('OP')) {
              shiftSpan.className = 'shift-op';
            } else if (shiftText.includes('MID')) {
              shiftSpan.className = 'shift-mid';
            } else if (shiftText.includes('CL')) {
              shiftSpan.className = 'shift-cl';
            } else if (shiftText.includes('NT')) {
              shiftSpan.className = 'shift-nt';
            }
            
            // -4가 포함된 경우 -4 부분만 노란색으로 변경
            if (shiftText.includes('-4')) {
              const parts = shiftText.split('-4');
              shiftSpan.innerHTML = parts[0] + '<span class="shift-4">-4</span>' + (parts[1] || '');
            } else {
              shiftSpan.textContent = shiftText;
            }
          }
          
          shiftCell.appendChild(shiftSpan);
        } else if (s.workShift) {
          // 기존 데이터 사용
          let shiftText = s.workShift.toString();
          let shiftSpan = document.createElement('span');
          
          // M-4&C-4 시프트 처리 (최우선 적용)
          if (shiftText.includes('M-4&C') || shiftText.includes('M-4 & C') || shiftText.includes('M-4&C-4')) {
            shiftSpan.className = 'shift-mc';
            shiftSpan.textContent = shiftText; // 전체 텍스트를 그대로 표시
          } 
          // 다른 시프트 처리
          else {
            // 시프트 배경색 및 글자색 설정
            if (shiftText.includes('OP')) {
              shiftSpan.className = 'shift-op';
            } else if (shiftText.includes('MID')) {
              shiftSpan.className = 'shift-mid';
            } else if (shiftText.includes('CL')) {
              shiftSpan.className = 'shift-cl';
            } else if (shiftText.includes('NT')) {
              shiftSpan.className = 'shift-nt';
            }
            
            // -4가 포함된 경우 -4 부분만 노란색으로 변경
            if (shiftText.includes('-4')) {
              const parts = shiftText.split('-4');
              shiftSpan.innerHTML = parts[0] + '<span class="shift-4">-4</span>' + (parts[1] || '');
            } else {
              shiftSpan.textContent = shiftText;
            }
          }
          
          shiftCell.appendChild(shiftSpan);
        } else {
          shiftCell.textContent = '-';
        }
        
        // WH 셀
        const whCell = row.insertCell(2);
        whCell.textContent = s.workHours;
        
        // 총 건수 셀 - 배경에 막대 그래프 추가
        const totalCell = row.insertCell(3);
        totalCell.textContent = s.total;
        
        // 평균보다 높으면 배경에 막대 그래프 추가
        if (s.total > avgTotalCount) {
          const barWidth = Math.min(100, (s.total / maxTotalCount) * 100);
          const bar = document.createElement('div');
          bar.className = 'total-bar';
          bar.style.width = `${barWidth}%`;
          totalCell.appendChild(bar);
          
          // 스파크라인 추가 (막대 그래프)
          const sparklineContainer = document.createElement('span');
          sparklineContainer.className = 'sparkline-container';
          totalCell.appendChild(sparklineContainer);
          
          // 스파크라인 데이터 (최근 5개 데이터 포인트를 시뮬레이션 또는 실제 데이터 사용)
          const sparkData = performanceData && performanceData.trend ? 
            performanceData.trend : 
            [s.total * 0.7, s.total * 0.8, s.total * 0.9, s.total * 0.95, s.total];
          
          // 스파크라인 초기화는 테이블 렌더링 후 별도로 수행
          setTimeout(() => {
            $(sparklineContainer).sparkline(sparkData, {
              type: 'bar',
              height: '20px',
              barWidth: 3,
              barColor: '#0d6efd'
            });
          }, 100);
        }
        
        // 총 점수 셀 - 점수에 따라 색상 변경
        const scoreCell = row.insertCell(4);
        const scoreValue = s.totalScore;
        scoreCell.textContent = scoreValue.toFixed(1); // 소수점 한 자리까지 표시
        
        // 점수에 따른 스타일 적용
        if (scoreValue >= s.total * 0.8) {
          scoreCell.className = 'score-high';
        } else if (scoreValue >= s.total * 0.5) {
          scoreCell.className = 'score-medium';
        } else {
          scoreCell.className = 'score-low';
        }
        
        // 성과 점수가 있으면 스파크라인 추가
        if (performanceData && performanceData.performanceScore) {
          const sparklineContainer = document.createElement('span');
          sparklineContainer.className = 'sparkline-container';
          scoreCell.appendChild(sparklineContainer);
          
          // 스파크라인 초기화는 테이블 렌더링 후 별도로 수행
          setTimeout(() => {
            $(sparklineContainer).sparkline([performanceData.performanceScore], {
              type: 'bullet',
              targetColor: '#666',
              performanceColor: scoreValue >= s.total * 0.8 ? '#28a745' : (scoreValue >= s.total * 0.5 ? '#fd7e14' : '#dc3545'),
              rangeColors: ['#D3D3D3', '#BEBEBE', '#A9A9A9'],
              width: '80px',
              height: '20px',
              targetWidth: 2
            });
          }, 100);
        }
        
        // 오퍼레이터 배차 셀 - 비율 표시 및 스파크라인 추가
        const operatorCell = row.insertCell(5);
        const operatorRatio = Math.round(s.operatorDispatch/s.total*100);
        operatorCell.textContent = `${s.operatorDispatch} (${operatorRatio}%)`;
        
        // 오퍼레이터 배차 비율이 높으면 스파크라인 추가
        if (operatorRatio > 50) {
          const sparklineContainer = document.createElement('span');
          sparklineContainer.className = 'sparkline-container';
          operatorCell.appendChild(sparklineContainer);
          
          // 스파크라인 데이터 (파이 차트)
          const sparkData = [operatorRatio, 100 - operatorRatio];
          
          // 스파크라인 초기화는 테이블 렌더링 후 별도로 수행
          setTimeout(() => {
            $(sparklineContainer).sparkline(sparkData, {
              type: 'pie',
              height: '20px',
              sliceColors: ['#28a745', '#dee2e6']
            });
          }, 100);
        }
        
        // 시스템 배차 셀
        const systemCell = row.insertCell(6);
        const systemRatio = Math.round(s.systemDispatch/s.total*100);
        systemCell.textContent = `${s.systemDispatch} (${systemRatio}%)`;
        
        // 시스템 배차 비율이 높으면 스파크라인 추가
        if (systemRatio > 30) {
          const sparklineContainer = document.createElement('span');
          sparklineContainer.className = 'sparkline-container';
          systemCell.appendChild(sparklineContainer);
          
          // 스파크라인 데이터 (파이 차트)
          const sparkData = [systemRatio, 100 - systemRatio];
          
          // 스파크라인 초기화는 테이블 렌더링 후 별도로 수행
          setTimeout(() => {
            $(sparklineContainer).sparkline(sparkData, {
              type: 'pie',
              height: '20px',
              sliceColors: ['#0d6efd', '#dee2e6']
            });
          }, 100);
        }
        
        // 처리 불가 셀 - 비율에 따라 배경색 변경
        const cantProcessCell = row.insertCell(7);
        const cantProcessRatio = Math.round(s.cantProcess/s.total*100);
        cantProcessCell.textContent = `${s.cantProcess} (${cantProcessRatio}%)`;
        
        // 처리 불가 비율에 따른 스타일 적용
        if (cantProcessRatio > 20) {
          cantProcessCell.className = 'cant-process-high';
        } else if (cantProcessRatio > 10) {
          cantProcessCell.className = 'cant-process-medium';
        }
        
        // 평균 소요시간 셀 - 라인 차트 추가
        const avgTimeCell = row.insertCell(8);
        avgTimeCell.textContent = `${Math.round(s.avgTime)} 초`;
        
        // 소요시간 샘플이 있으면 라인 차트 추가
        if (s.timeSamples && s.timeSamples.length > 0) {
          const sparklineContainer = document.createElement('span');
          sparklineContainer.className = 'sparkline-container';
          avgTimeCell.appendChild(sparklineContainer);
          
          // 최근 5개의 소요시간 샘플만 사용
          const recentSamples = s.timeSamples.slice(-5);
          
          // 스파크라인 초기화는 테이블 렌더링 후 별도로 수행
          setTimeout(() => {
            $(sparklineContainer).sparkline(recentSamples, {
              type: 'line',
              lineColor: '#6c757d',
              fillColor: 'rgba(108, 117, 125, 0.2)',
              width: '50px',
              height: '20px',
              spotColor: '#dc3545',
              minSpotColor: '#28a745',
              maxSpotColor: '#dc3545',
              highlightSpotColor: '#fd7e14',
              highlightLineColor: '#fd7e14'
            });
          }, 100);
        }
        
        // 목표 달성 셀 - 달성 여부에 따라 스타일 변경
        const goalCell = row.insertCell(9);
        
        if (s.goalAchievement) {
          const goalSpan = document.createElement('span');
          
          // 목표 달성 여부에 따른 스타일 적용
          if (s.goalAchievement.includes('달성') || s.goalAchievement.includes('성공') || 
              s.goalAchievement.includes('O') || s.goalAchievement.includes('Y')) {
            goalSpan.className = 'goal-achieved';
            goalSpan.innerHTML = `${s.goalAchievement} <i class="fas fa-trophy"></i>`;
          } else {
            goalSpan.className = 'goal-not-achieved';
            goalSpan.innerHTML = `${s.goalAchievement} <i class="fas fa-exclamation-triangle"></i>`;
          }
          
          goalCell.appendChild(goalSpan);
        } else {
          goalCell.textContent = '-';
        }
      });
      
      // 스파크라인 초기화 (jQuery가 필요함)
      setTimeout(() => {
        $('.sparkline').sparkline();
      }, 200);
    }
    
    // 정렬 이벤트 리스너 설정
    function setupSortListeners() {
      const headers = document.querySelectorAll('.sortable');
      
      headers.forEach(header => {
        header.style.cursor = 'pointer';
        
        // 초기 상태의 정렬 표시
        if (header.getAttribute('data-sort') === currentSort.column) {
          const icon = header.querySelector('i');
          if (currentSort.direction === 'asc') {
            icon.className = 'fas fa-sort-up';
          } else if (currentSort.direction === 'desc') {
            icon.className = 'fas fa-sort-down';
          } else {
            icon.className = 'fas fa-sort';
          }
        }
        
        header.addEventListener('click', () => {
          const column = header.getAttribute('data-sort');
          
          // 정렬 방향 토글
          if (currentSort.column === column) {
            // 같은 열 클릭 시: 내림차순 -> 오름차순 -> 정렬 종료 -> 내림차순 순으로 변경
            currentSort.clickCount = (currentSort.clickCount + 1) % 3;
            
            if (currentSort.clickCount === 0) {
              // 내림차순
              currentSort.direction = 'desc';
            } else if (currentSort.clickCount === 1) {
              // 오름차순
              currentSort.direction = 'asc';
            } else {
              // 정렬 종료 (기본 정렬로 돌아감)
              currentSort.direction = 'none';
            }
          } else {
            // 새로운 열 선택 시 항상 내림차순으로 시작
            currentSort.column = column;
            currentSort.direction = 'desc';
            currentSort.clickCount = 0; // 내림차순 상태
          }
          
          // 모든 헤더의 아이콘 초기화
          headers.forEach(h => {
            h.querySelector('i').className = 'fas fa-sort';
          });
          
          // 선택된 헤더의 아이콘 업데이트
          const icon = header.querySelector('i');
          if (currentSort.direction === 'asc') {
            // 오름차순
            icon.className = 'fas fa-sort-up';
          } else if (currentSort.direction === 'desc') {
            // 내림차순
            icon.className = 'fas fa-sort-down';
          } else {
            // 정렬 없음
            icon.className = 'fas fa-sort';
          }
          
          // 테이블 다시 렌더링
          renderDispatcherTable();
        });
      });
    }
    
    // 필터 이벤트 리스너 설정
    function setupFilterListeners() {
      const filterInput = document.getElementById('dispatcher-filter');
      const clearButton = document.getElementById('clear-filter');
      
      filterInput.addEventListener('input', () => {
        filterText = filterInput.value;
        renderDispatcherTable();
      });
      
      clearButton.addEventListener('click', () => {
        filterInput.value = '';
        filterText = '';
        renderDispatcherTable();
      });
    }
    
    // 테이블 캡처 기능 설정
    function setupCaptureButton() {
      const captureButton = document.getElementById('capture-table');
      const statsTable = document.getElementById('dispatcher-stats-table');
      
      captureButton.addEventListener('click', async () => {
        try {
          // 로딩 표시
          const loadingDiv = document.createElement('div');
          loadingDiv.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-dark bg-opacity-50';
          loadingDiv.style.zIndex = '9999';
          loadingDiv.innerHTML = '<div class="spinner-border text-light" role="status"><span class="visually-hidden">캡처 중...</span></div>';
          document.body.appendChild(loadingDiv);
          
          // 테이블 캡처
          const canvas = await html2canvas(statsTable, {
            backgroundColor: '#ffffff',
            scale: 2, // 고해상도로 캡처
            logging: false,
            useCORS: true
          });
          
          // 캔버스를 이미지로 변환
          const imageData = canvas.toDataURL('image/png');
          
          // 클립보드에 복사하기 위한 임시 요소 생성
          const tempImg = document.createElement('img');
          tempImg.src = imageData;
          
          // 클립보드에 복사
          try {
            // 새로운 ClipboardItem API 사용 (최신 브라우저)
            const blob = await (await fetch(imageData)).blob();
            await navigator.clipboard.write([
              new ClipboardItem({
                [blob.type]: blob
              })
            ]);
            alert('테이블이 클립보드에 복사되었습니다.');
          } catch (clipboardError) {
            // 대체 방법: 이미지 다운로드
            console.error('클립보드 복사 실패:', clipboardError);
            
            // 다운로드 링크 생성
            const downloadLink = document.createElement('a');
            downloadLink.href = imageData;
            downloadLink.download = '담당자별_상세_통계_' + new Date().toISOString().slice(0, 10) + '.png';
            downloadLink.click();
            alert('클립보드 복사에 실패했습니다. 이미지가 다운로드됩니다.');
          }
          
          // 로딩 표시 제거
          document.body.removeChild(loadingDiv);
        } catch (error) {
          console.error('테이블 캡처 중 오류 발생:', error);
          alert('테이블 캡처 중 오류가 발생했습니다.');
        }
      });
    }
    
    // 전체 요약 통계 표시
    function displaySummary(summary) {
      if (!summary) return;
      
      try {
        // 요약 카드 업데이트
        if (document.getElementById('total-count')) {
          document.getElementById('total-count').textContent = summary.total || 0;
        }
        
        // dispatchResults가 존재하는지 확인
        if (summary.dispatchResults) {
          // 시스템 배차 비율 계산
          let systemCount = 0;
          if (summary.dispatchResults['시스템 배차']) {
            systemCount = summary.dispatchResults['시스템 배차'];
          }
          const systemRate = Math.round((systemCount / (summary.total || 1)) * 100);
          
          if (document.getElementById('system-dispatch-rate')) {
            document.getElementById('system-dispatch-rate').textContent = `${systemRate}%`;
          }
          
          // 오퍼레이터 배차 비율 계산
          let operatorCount = 0;
          if (summary.dispatchResults['오퍼레이터 배차']) {
            operatorCount = summary.dispatchResults['오퍼레이터 배차'];
          }
          const operatorRate = Math.round((operatorCount / (summary.total || 1)) * 100);
          
          if (document.getElementById('operator-dispatch-rate')) {
            document.getElementById('operator-dispatch-rate').textContent = `${operatorRate}%`;
          }
        } else {
          console.warn('dispatchResults가 정의되지 않았습니다.');
          // 기본값 설정
          if (document.getElementById('system-dispatch-rate')) {
            document.getElementById('system-dispatch-rate').textContent = '0%';
          }
          if (document.getElementById('operator-dispatch-rate')) {
            document.getElementById('operator-dispatch-rate').textContent = '0%';
          }
        }
        
        // 평균 지연 시간 표시
        if (document.getElementById('avg-delay-time')) {
          document.getElementById('avg-delay-time').textContent = Math.round(summary.avgDelayTime || 0);
        }
        
        // 지역별 차트 데이터 생성
        const regionChartData = [['지역', '건수']];
        
        // 지역 데이터가 있는 경우에만 처리
        if (summary.regions) {
          // 데이터 정렬 (건수 기준 내림차순)
          const sortedRegions = Object.keys(summary.regions)
            .map(region => ({ region, count: summary.regions[region] }))
            .sort((a, b) => b.count - a.count);
          
          sortedRegions.forEach(item => {
            regionChartData.push([`지역 ${item.region}`, item.count]);
          });
          
          // 지역별 차트 그리기 (분리된 함수 호출)
          if (typeof displayRegionChart === 'function') {
            displayRegionChart(regionChartData);
          }
        }
      } catch (error) {
        console.error('요약 통계 표시 중 오류 발생:', error);
      }
    }
    
    // 시간대별 통계 표시
    function displayHourlyStats(hourlyStats) {
      if (!hourlyStats || hourlyStats.length === 0) return;
      
      const chartContainer = document.getElementById('hourly-chart');
      if (!chartContainer) return;
      
      try {
        // DataTable 생성
        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', '시간대');
        dataTable.addColumn('number', '건수');
        
        // 행 추가
        hourlyStats.forEach(stat => {
          dataTable.addRow([`${stat.hour}시`, stat.count]);
        });
        
        // 차트 옵션
        const options = {
          title: '시간대별 배차 건수',
          chartArea: {
            left: 50,
            top: 30,
            width: '80%',
            height: '75%'
          },
          legend: {position: 'none'},
          colors: ['#34A853'],
          hAxis: {
            title: '시간대',
            slantedText: false,
            showTextEvery: 1
          },
          vAxis: {
            title: '건수',
            minValue: 0
          },
          animation: {
            startup: true,
            duration: 1000,
            easing: 'out'
          },
          bar: {groupWidth: '70%'},
          width: '100%',
          height: '100%',
          tooltip: { isHtml: true }
        };
        
        // 차트 그리기
        const chart = new google.visualization.ColumnChart(chartContainer);
        chart.draw(dataTable, options);
        
        // 전역 함수 정의
        window.drawHourlyChart = function() {
          try {
            chart.draw(dataTable, options);
          } catch(e) {
            console.error("시간대별 차트 그리기 오류:", e);
          }
        };
      
      } catch (e) {
        console.error("시간대별 차트 생성 오류:", e);
        if (chartContainer) {
          chartContainer.innerHTML = '<div class="alert alert-warning">차트 로드 중 오류가 발생했습니다.</div>';
        }
      }
    }
    
    // 고성과자/저성과자 표시 함수
    function displayPerformers(performersData) {
      if (!performersData) return;
      
      try {
        // Top 5 고성과자 표시
        const topBody = document.getElementById('top-performers-body');
        if (!topBody) return;
        
        topBody.innerHTML = '';
        
        if (performersData.top && performersData.top.length > 0) {
          performersData.top.forEach((performer, index) => {
            const row = topBody.insertRow();
            
            // 순위 셀 - 메달 아이콘 추가
            const rankCell = row.insertCell(0);
            
            if (index < 3) {
              // 메달 아이콘 (1-3위)
              const medalIcons = [
                '<i class="fas fa-trophy medal-gold"></i>',
                '<i class="fas fa-medal medal-silver"></i>',
                '<i class="fas fa-award medal-bronze"></i>'
              ];
              rankCell.innerHTML = `${medalIcons[index]} ${index + 1}위`;
              rankCell.style.fontWeight = 'bold';
            } else {
              rankCell.textContent = `${index + 1}위`;
            }
            
            // 나머지 셀 추가
            row.insertCell(1).textContent = performer.dispatcher || '';
            row.insertCell(2).textContent = performer.total || 0;
            row.insertCell(3).textContent = performer.totalScore || 0;
            
            const opDispatchCell = row.insertCell(4);
            if (performer.operatorDispatch !== undefined && performer.total) {
              const ratio = Math.round((performer.operatorDispatch / performer.total) * 100);
              opDispatchCell.textContent = `${performer.operatorDispatch} (${ratio}%)`;
            } else {
              opDispatchCell.textContent = '0 (0%)';
            }
            
            row.insertCell(5).textContent = `${Math.round(performer.avgTime || 0)} 초`;
          });
        }
        
        // Bottom 5 저성과자 표시
        const bottomBody = document.getElementById('bottom-performers-body');
        if (!bottomBody) return;
        
        bottomBody.innerHTML = '';
        
        if (performersData.bottom && performersData.bottom.length > 0) {
          performersData.bottom.forEach((performer, index) => {
            const row = bottomBody.insertRow();
            
            // 셀 추가
            row.insertCell(0).textContent = `${(performersData.totalCount || 0) - index}위`;
            row.insertCell(1).textContent = performer.dispatcher || '';
            row.insertCell(2).textContent = performer.total || 0;
            row.insertCell(3).textContent = performer.totalScore || 0;
            
            const opDispatchCell = row.insertCell(4);
            if (performer.operatorDispatch !== undefined && performer.total) {
              const ratio = Math.round((performer.operatorDispatch / performer.total) * 100);
              opDispatchCell.textContent = `${performer.operatorDispatch} (${ratio}%)`;
            } else {
              opDispatchCell.textContent = '0 (0%)';
            }
            
            row.insertCell(5).textContent = `${Math.round(performer.avgTime || 0)} 초`;
          });
        }
      } catch (error) {
        console.error('성과자 데이터 표시 중 오류:', error);
      }
    }
  </script>
